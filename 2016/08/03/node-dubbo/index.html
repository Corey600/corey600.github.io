<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>使用node开发dubbo远程调用客户端 | Corey's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">使用node开发dubbo远程调用客户端</h1><a id="logo" href="/.">Corey's Blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">使用node开发dubbo远程调用客户端</h1><div class="post-meta">Aug 3, 2016<span> | </span><span class="category"><a href="/categories/备忘/">备忘</a></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基本架构"><span class="toc-number">1.1.</span> <span class="toc-text">基本架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#调用关系说明"><span class="toc-number">1.2.</span> <span class="toc-text">调用关系说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署dubbo环境"><span class="toc-number">2.</span> <span class="toc-text">部署dubbo环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#zookeeper注册中心"><span class="toc-number">2.1.</span> <span class="toc-text">zookeeper注册中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用tomcat启动管理控制台"><span class="toc-number">2.2.</span> <span class="toc-text">使用tomcat启动管理控制台</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简单的提供者和消费者"><span class="toc-number">3.</span> <span class="toc-text">简单的提供者和消费者</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#服务提供者"><span class="toc-number">3.1.</span> <span class="toc-text">服务提供者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务消费者"><span class="toc-number">3.2.</span> <span class="toc-text">服务消费者</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node客户端设计"><span class="toc-number">4.</span> <span class="toc-text">node客户端设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#整体流程"><span class="toc-number">4.1.</span> <span class="toc-text">整体流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#编解码及序列化"><span class="toc-number">4.2.</span> <span class="toc-text">编解码及序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#发送的传输协议格式"><span class="toc-number">4.2.1.</span> <span class="toc-text">发送的传输协议格式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#接收的传输协议格式"><span class="toc-number">4.2.2.</span> <span class="toc-text">接收的传输协议格式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端实现源码"><span class="toc-number">5.</span> <span class="toc-text">客户端实现源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Todo-List"><span class="toc-number">6.</span> <span class="toc-text">Todo List</span></a></li></ol></div></div><div class="post-content"><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><blockquote>
<p>DUBBO是一个分布式服务框架，致力于提供高性能和透明化的RPC远程服务调用方案，是阿里巴巴SOA服务化治理方案的核心框架，每天为2,000+个服务提供3,000,000,000+次访问量支持，并被广泛应用于阿里巴巴集团的各成员站点。</p>
</blockquote>
<h4 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h4><p>其中 Monitor 和 Container 暂时略过不讲：</p>
<ul>
<li><strong>Provider: 暴露服务的服务提供方。</strong></li>
<li><strong>Consumer: 调用远程服务的服务消费方。</strong></li>
<li><strong>Registry: 服务注册与发现的注册中心。</strong></li>
<li>Monitor: 统计服务的调用次调和调用时间的监控中心。</li>
<li>Container: 服务运行容器。</li>
</ul>
<p><img src="/images/20160803/dubbo-architecture.jpg" alt="architecture"></p>
<a id="more"></a>
<h4 id="调用关系说明"><a href="#调用关系说明" class="headerlink" title="调用关系说明"></a>调用关系说明</h4><ol>
<li>服务提供者在启动时，向注册中心注册自己提供的服务。</li>
<li>服务消费者在启动时，向注册中心订阅自己所需的服务。</li>
<li>注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。</li>
<li>服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进行调用，如果调用失败，再选另一台调用。</li>
</ol>
<p><em>参考链接</em> : <a href="http://dubbo.io/User+Guide-zh.htm#UserGuide-zh-%E6%9E%B6%E6%9E%84" target="_blank" rel="external">dubbo架构</a></p>
<h3 id="部署dubbo环境"><a href="#部署dubbo环境" class="headerlink" title="部署dubbo环境"></a>部署dubbo环境</h3><p>系统环境需要 jdk1.7，如果是 centos，默认安装的是 openJDK，需要卸载后重新安装 jdk1.7。</p>
<p><em>下载链接</em> : <a href="http://mirrors.hust.edu.cn/apache/zookeeper/zookeeper-3.4.8/zookeeper-3.4.8.tar.gz" target="_blank" rel="external">zookeeper</a> / <a href="http://apache.fayea.com/tomcat/tomcat-6/v6.0.45/bin/apache-tomcat-6.0.45.tar.gz" target="_blank" rel="external">tomcat</a></p>
<h4 id="zookeeper注册中心"><a href="#zookeeper注册中心" class="headerlink" title="zookeeper注册中心"></a>zookeeper注册中心</h4><p>解压安装</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">tar</span> <span class="selector-tag">zxvf</span> <span class="selector-tag">zookeeper-3</span><span class="selector-class">.4</span><span class="selector-class">.8</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></div><div class="line"><span class="selector-tag">cd</span> <span class="selector-tag">zookeeper-3</span><span class="selector-class">.4</span><span class="selector-class">.8</span></div></pre></td></tr></table></figure>
<p>创建配置文件</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vim</span> <span class="keyword">conf</span>/zoo.cfg</div></pre></td></tr></table></figure>
<p>修改zoo.cfg的内容如下</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">tickTime</span>=<span class="number">2000</span></div><div class="line"><span class="attr">dataDir</span>=/var/lib/zookeeper</div><div class="line"><span class="attr">clientPort</span>=<span class="number">2181</span></div></pre></td></tr></table></figure>
<p>启动</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/zkServer<span class="selector-class">.sh</span> start</div></pre></td></tr></table></figure>
<p>停止</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/zkServer<span class="selector-class">.sh</span> stop</div></pre></td></tr></table></figure>
<h4 id="使用tomcat启动管理控制台"><a href="#使用tomcat启动管理控制台" class="headerlink" title="使用tomcat启动管理控制台"></a>使用tomcat启动管理控制台</h4><p>解压安装tomcat，并删除默认的 webapps/ROOT 目录</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tar zxvf apache-tomcat<span class="number">-6.0</span><span class="number">.45</span>.tar.gz</div><div class="line">cd apache-tomcat<span class="number">-6.0</span><span class="number">.45</span></div><div class="line">rm -rf webapps/ROOT</div></pre></td></tr></table></figure>
<p>将dubbo管理控制台包解压到 webapps/ROOT 目录</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unzip dubbo-admin<span class="number">-2.4</span><span class="number">.1</span>.war -d webapps/ROOT</div></pre></td></tr></table></figure>
<p>修改配置文件 webapps/ROOT/WEB-INF/dubbo.properties 为如下内容，因为和 zookeeper 注册中心部署在同一台机器，这里配置为本地地址 <code>zookeeper://127.0.0.1:2181</code> 就可以了</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dubbo<span class="selector-class">.registry</span><span class="selector-class">.address</span>=zookeeper:<span class="comment">//127.0.0.1:2181</span></div><div class="line">dubbo<span class="selector-class">.admin</span><span class="selector-class">.root</span><span class="selector-class">.password</span>=root</div><div class="line">dubbo<span class="selector-class">.admin</span><span class="selector-class">.guest</span><span class="selector-class">.password</span>=guest</div></pre></td></tr></table></figure>
<p>启动</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.<span class="regexp">/bin/</span>startup.sh</div></pre></td></tr></table></figure>
<p>停止</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/<span class="built_in">shutdown</span>.sh</div></pre></td></tr></table></figure>
<p>访问 <code>http://127.0.0.1:8080/</code>: (用户:root,密码:root 或 用户:guest,密码:guest)</p>
<h3 id="简单的提供者和消费者"><a href="#简单的提供者和消费者" class="headerlink" title="简单的提供者和消费者"></a>简单的提供者和消费者</h3><h4 id="服务提供者"><a href="#服务提供者" class="headerlink" title="服务提供者"></a>服务提供者</h4><p>定义服务接口: (该接口需单独打包，在服务提供方和消费方共享)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DemoService.java</span></div><div class="line"><span class="keyword">package</span> com.alibaba.dubbo.demo;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DemoService</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">(String name)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在服务提供方实现接口：(对服务消费方隐藏实现)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DemoServiceImpl.java</span></div><div class="line"><span class="keyword">package</span> com.alibaba.dubbo.demo.provider;</div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.demo.DemoService;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoServiceImpl</span> <span class="keyword">implements</span> <span class="title">DemoService</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Hello "</span> + name;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用Spring配置声明暴露服务：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- provider.xml --&gt;</span></div><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">    <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></div><div class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">    http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">    http://code.alibabatech.com/schema/dubbo</div><div class="line">    http://code.alibabatech.com/schema/dubbo/dubbo.xsd"&gt;</div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 提供方应用信息，用于计算依赖关系 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"hello-world-app"</span>  /&gt;</span></div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 使用multicast广播注册中心暴露服务地址 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"multicast://224.5.6.7:1234"</span> /&gt;</span></div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 用dubbo协议在20880端口暴露服务 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"dubbo"</span> <span class="attr">port</span>=<span class="string">"20880"</span> /&gt;</span></div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 声明需要暴露的服务接口 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"com.alibaba.dubbo.demo.DemoService"</span> <span class="attr">ref</span>=<span class="string">"demoService"</span> /&gt;</span></div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 和本地bean一样实现服务 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demoService"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.dubbo.demo.provider.DemoServiceImpl"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>加载Spring配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Provider.java</span></div><div class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        String configLocation = <span class="string">"spring/dubbo-provider.xml"</span>;</div><div class="line">        ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(configLocation);</div><div class="line">        context.start();</div><div class="line">        System.in.read(); <span class="comment">// 按任意键退出</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="服务消费者"><a href="#服务消费者" class="headerlink" title="服务消费者"></a>服务消费者</h4><p>通过Spring配置引用远程服务：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- consumer.xml --&gt;</span></div><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">    <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></div><div class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">    http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">    http://code.alibabatech.com/schema/dubbo</div><div class="line">    http://code.alibabatech.com/schema/dubbo/dubbo.xsd"&gt;</div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 消费方应用名，用于计算依赖关系，不是匹配条件，不要与提供方一样 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"consumer-of-helloworld-app"</span>  /&gt;</span></div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 使用multicast广播注册中心暴露发现服务地址 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"multicast://224.5.6.7:1234"</span> /&gt;</span></div><div class="line"> </div><div class="line">    <span class="comment">&lt;!-- 生成远程服务代理，可以和本地bean一样使用demoService --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"demoService"</span> <span class="attr">interface</span>=<span class="string">"com.alibaba.dubbo.demo.DemoService"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>加载Spring配置，并调用远程服务：(也可以使用IoC注入)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Consumer.java</span></div><div class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.demo.DemoService;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        String configLocation = <span class="string">"spring/dubbo-consumer.xml"</span>;</div><div class="line">        ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(configLocation);</div><div class="line">        context.start();</div><div class="line">        DemoService demoService = (DemoService)context.getBean(<span class="string">"demoService"</span>); <span class="comment">// 获取 远程 服务代理</span></div><div class="line">        String hello = demoService.sayHello(<span class="string">"world"</span>); <span class="comment">// 执行远程方法</span></div><div class="line">        System.out.println( hello ); <span class="comment">// 显示调用结果</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>参考链接</em> : <a href="http://www.tuicool.com/articles/bYfIBfU" target="_blank" rel="external">Dubbo实例</a></p>
<h3 id="node客户端设计"><a href="#node客户端设计" class="headerlink" title="node客户端设计"></a>node客户端设计</h3><h4 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h4><p><img src="/images/20160803/dubbo.png" alt="dubbo"></p>
<h4 id="编解码及序列化"><a href="#编解码及序列化" class="headerlink" title="编解码及序列化"></a>编解码及序列化</h4><h5 id="发送的传输协议格式"><a href="#发送的传输协议格式" class="headerlink" title="发送的传输协议格式"></a>发送的传输协议格式</h5><p>协议头为定长 16个字节（128位）</p>
<ul>
<li>0 - 1B dubbo协议魔数(short) 固定为 0xda 0xbb</li>
<li>2 - 2B 消息标志位</li>
<li>3 - 3B 状态位</li>
<li>4 -11B 设置消息的id long类型</li>
<li>12 -15B 设置消息体body长度 int类型</li>
</ul>
<p>协议体为hessian2序列化后的数据，数据值按顺序依次为</p>
<ul>
<li><ol>
<li>dubbo的版本信息</li>
</ol>
</li>
<li><ol>
<li>服务接口名</li>
</ol>
</li>
<li><ol>
<li>服务的版本号</li>
</ol>
</li>
<li><ol>
<li>调服务的方法名</li>
</ol>
</li>
<li><ol>
<li>调服务的方法的参数描述符</li>
</ol>
</li>
<li><ol>
<li>遍历传输的参数值逐个序列化</li>
</ol>
</li>
<li><ol>
<li>将整个附属信息map对象attachments序列化</li>
</ol>
</li>
</ul>
<p>其中，方法的参数必须符合 java 类型表示的方法，具体可以参考模块说明： <a href="https://github.com/node-modules/js-to-java" target="_blank" rel="external">js-to-java</a></p>
<h5 id="接收的传输协议格式"><a href="#接收的传输协议格式" class="headerlink" title="接收的传输协议格式"></a>接收的传输协议格式</h5><p><img src="/images/20160803/dubbo_protocol_header.jpg" alt="parse"></p>
<p>其中 16-20位为序列化协议的类型ID，hessian2 的协议ID为 2，node客户端目前不支持其他的序列化协议。</p>
<p>其中 24-31未为状态位，具体值表示如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">value</th>
<th style="text-align:center">msg</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">20</td>
<td style="text-align:center">‘ok’</td>
</tr>
<tr>
<td style="text-align:center">30</td>
<td style="text-align:center">‘clien side timeout’</td>
</tr>
<tr>
<td style="text-align:center">31</td>
<td style="text-align:center">‘server side timeout’</td>
</tr>
<tr>
<td style="text-align:center">40</td>
<td style="text-align:center">‘request format error’</td>
</tr>
<tr>
<td style="text-align:center">50</td>
<td style="text-align:center">‘response format error’</td>
</tr>
<tr>
<td style="text-align:center">60</td>
<td style="text-align:center">‘service not found’</td>
</tr>
<tr>
<td style="text-align:center">70</td>
<td style="text-align:center">‘service error’</td>
</tr>
<tr>
<td style="text-align:center">80</td>
<td style="text-align:center">‘internal server error’</td>
</tr>
<tr>
<td style="text-align:center">90</td>
<td style="text-align:center">‘internal server error’</td>
</tr>
</tbody>
</table>
<p>协议体为hessian序列化后的数据，需要反序列化后读取。第一个读取的数据为整数，方法表示返回值类型，具体值表示如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 结果标志位为数据段第一个字节，为 0x90 0x91 0x92其中之一</span></div><div class="line"><span class="comment">// 实际为hessian协议的简化整数表示，反序列化后为： 0 1 2</span></div><div class="line">RESPONSE_WITH_EXCEPTION = <span class="number">0</span>; <span class="comment">// 返回的是java异常</span></div><div class="line">RESPONSE_VALUE = <span class="number">1</span>; <span class="comment">// 返回方法的返回值</span></div><div class="line">RESPONSE_NULL_VALUE = <span class="number">2</span>; <span class="comment">// 该方法没有返回值</span></div></pre></td></tr></table></figure>
<p>如果有，随后读取的就是具体的返回值数据，也符合 java 类型表示的方法。</p>
<h3 id="客户端实现源码"><a href="#客户端实现源码" class="headerlink" title="客户端实现源码"></a>客户端实现源码</h3><p><a href="https://github.com/Corey600/zoodubbo" target="_blank" rel="external">https://github.com/Corey600/zoodubbo</a></p>
<h3 id="Todo-List"><a href="#Todo-List" class="headerlink" title="Todo List"></a>Todo List</h3><ol>
<li>缓存服务列表，监听变化更新列表，不再每次都重新获取</li>
<li>使用连接池管理连接，添加负载均衡策略</li>
<li>累计调用次数和调用时间，定时发送统计数据到监控中心</li>
</ol>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://corey600.github.io/2016/08/03/node-dubbo/" data-id="cj1q6aj3v001n08qdsp6trf74" class="article-share-link">分享到</a><div class="tags"><a href="/tags/前端/">前端</a><a href="/tags/node/">node</a><a href="/tags/dubbo/">dubbo</a></div><div class="post-nav"><a href="/2016/09/28/koa-and-co/" class="pre">koa和co的简单分析</a><a href="/2016/07/22/private-npm-service/" class="next">私有NPM服务搭建</a></div><div class="comments-link-to"><span>想添加评论吗？给</span><span class="comments-email-to">我 (fcx600#163.com)</span><span>发邮件吧。或者请移步</span><a href="https://github.com/Corey600/static-blog/issues/new" target="_blank">这里</a><span>提交。</span></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/备忘/">备忘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/总结/">总结</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载/">转载</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/04/20/react-international/">React多语言方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/15/node-performance-analysis/">由一个简单Node服务引申的Node性能分析方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/28/koa-and-co/">koa和co的简单分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/03/node-dubbo/">使用node开发dubbo远程调用客户端</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/22/private-npm-service/">私有NPM服务搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/13/gulp-workflow/">gulp前端构建工作流</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/04/flash-player/">Flash播放器研究</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/11/vagrant-instructions/">使用vagrant虚拟机开发调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/07/js-class-inheritance/">JS的类和继承的实现方法比较</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/16/fiddler-instructions/">Fiddler使用说明</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/ACM/" style="font-size: 15px;">ACM</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/串口/" style="font-size: 15px;">串口</a> <a href="/tags/LCD/" style="font-size: 15px;">LCD</a> <a href="/tags/Vim/" style="font-size: 15px;">Vim</a> <a href="/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/tags/SublimeText2/" style="font-size: 15px;">SublimeText2</a> <a href="/tags/G/" style="font-size: 15px;">G++</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/Octopress/" style="font-size: 15px;">Octopress</a> <a href="/tags/Win7/" style="font-size: 15px;">Win7</a> <a href="/tags/VBox/" style="font-size: 15px;">VBox</a> <a href="/tags/Jekyll/" style="font-size: 15px;">Jekyll</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/夏令时/" style="font-size: 15px;">夏令时</a> <a href="/tags/字符串/" style="font-size: 15px;">字符串</a> <a href="/tags/前端/" style="font-size: 15px;">前端</a> <a href="/tags/Fiddler/" style="font-size: 15px;">Fiddler</a> <a href="/tags/TQ2440/" style="font-size: 15px;">TQ2440</a> <a href="/tags/类/" style="font-size: 15px;">类</a> <a href="/tags/继承/" style="font-size: 15px;">继承</a> <a href="/tags/flash/" style="font-size: 15px;">flash</a> <a href="/tags/播放器/" style="font-size: 15px;">播放器</a> <a href="/tags/vagrant/" style="font-size: 15px;">vagrant</a> <a href="/tags/nfs/" style="font-size: 15px;">nfs</a> <a href="/tags/fis/" style="font-size: 15px;">fis</a> <a href="/tags/npm/" style="font-size: 15px;">npm</a> <a href="/tags/cnpm/" style="font-size: 15px;">cnpm</a> <a href="/tags/gulp/" style="font-size: 15px;">gulp</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a> <a href="/tags/Node/" style="font-size: 15px;">Node</a> <a href="/tags/性能/" style="font-size: 15px;">性能</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a> <a href="/tags/koa/" style="font-size: 15px;">koa</a> <a href="/tags/co/" style="font-size: 15px;">co</a> <a href="/tags/React/" style="font-size: 15px;">React</a> <a href="/tags/i18n/" style="font-size: 15px;">i18n</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Corey's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>