<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>gulp前端构建工作流 | Corey's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">gulp前端构建工作流</h1><a id="logo" href="/.">Corey's Blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">gulp前端构建工作流</h1><div class="post-meta">Jun 13, 2016<span> | </span><span class="category"><a href="/categories/备忘/">备忘</a></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-第一步-清理上次构建的目标目录"><span class="toc-number">1.</span> <span class="toc-text">1. 第一步 - 清理上次构建的目标目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-第二步-增加语法检查"><span class="toc-number">2.</span> <span class="toc-text">2. 第二步 - 增加语法检查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-第三步-处理图片"><span class="toc-number">3.</span> <span class="toc-text">3. 第三步 - 处理图片</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-第四步-处理样式文件"><span class="toc-number">4.</span> <span class="toc-text">4. 第四步 - 处理样式文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-第五步-处理脚本文件"><span class="toc-number">5.</span> <span class="toc-text">5. 第五步 - 处理脚本文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-第六步-增加文件监听"><span class="toc-number">6.</span> <span class="toc-text">6. 第六步 - 增加文件监听</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#补充："><span class="toc-number">7.</span> <span class="toc-text">补充：</span></a></li></ol></div></div><div class="post-content"><p>在前端工程化中，目前最流行的是使用gulp构建前端代码。但gulp只是提供了一种流式的文件处理方式，具体的功能需要各种插件来实现。gulp插件种类繁多，各自实现了特定的功能，无法全部了解和熟悉，那么在决定构建方案的时候难免选择困难，无法快速准确地选择出自己需要插件。</p>
<p>但事实上一些常用的功能，已经有一些流行而成熟的插件被广泛地应用了，我们不需要自己大海捞针一样去搜寻和评估一大片插件才能选择到合适的插件。本文就是基于‘HTML5页面node化’的项目中使用到的插件，形成一个暂时较为通用的gulp构建工作流。随着项目的积累和深入，以后将会补充和修改。</p>
<p><em>注</em> ：gulp的基本使用方法将不会赘述。</p>
<h4 id="1-第一步-清理上次构建的目标目录"><a href="#1-第一步-清理上次构建的目标目录" class="headerlink" title="1. 第一步 - 清理上次构建的目标目录"></a>1. <em>第一步</em> - 清理上次构建的目标目录</h4><p>清理即是删除上次构建产生的文件。一般情况下，构建的目标目录需要和源码目录分开。这样在清理时，直接将构建的目标目录（这里为<code>dist</code>目录）下的所有文件删除即可。</p>
<a id="more"></a>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> del = <span class="built_in">require</span>(<span class="string">'del'</span>);</div><div class="line"></div><div class="line">gulp.task(<span class="string">'clean'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    del([<span class="string">'dist/*'</span>]);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="2-第二步-增加语法检查"><a href="#2-第二步-增加语法检查" class="headerlink" title="2. 第二步 - 增加语法检查"></a>2. <em>第二步</em> - 增加语法检查</h4><p>一般的集成开发环境会集成语法检查，而类似SublimeTest的一些文本编辑器则需要插件支持。这里直接在构建时，加入js语法检查，保证代码质量。</p>
<p>一般的js的语法检查工具有<code>jshint</code>、<code>jslint</code>和<code>eslint</code>等，各自的规则有所区别。这里使用<code>gulp-jshint</code>插件实现语法检查。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> jshint = <span class="built_in">require</span>(<span class="string">'gulp-jshint'</span>);</div><div class="line"></div><div class="line">gulp.task(<span class="string">'jshint'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> gulp.src([</div><div class="line">        <span class="string">'public/**/*.js'</span>,</div><div class="line">    ])</div><div class="line">        .pipe(jshint())</div><div class="line">        .pipe(jshint.reporter(<span class="string">'default'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="3-第三步-处理图片"><a href="#3-第三步-处理图片" class="headerlink" title="3. 第三步 - 处理图片"></a>3. <em>第三步</em> - 处理图片</h4><p>一般情况下，处理图片可能涉及到的压缩和生成雪碧图等。这里还未有这部分需求，所以只做了md5文件名后缀的添加。其中<code>rev()</code>用于给文件名扩展名前增加一个md5后缀，为文件内容的hash值，<code>rev.manifest()</code>用于生成增加后缀名前后的文件路径映射表，用于文件名的替换。</p>
<p>为什么要使用md5文件名后缀？这里是基于文件缓存策略的考虑。<br>具体可以参考：<a href="http://www.infoq.com/cn/articles/front-end-engineering-and-performance-optimization-part1/" target="_blank" rel="external">前端工程精粹（一）：静态资源版本更新与缓存</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> rev = <span class="built_in">require</span>(<span class="string">'gulp-rev'</span>);</div><div class="line"></div><div class="line">gulp.task(<span class="string">'image'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> gulp.src([</div><div class="line">        <span class="string">'public/**/*.+(ico|png|jpeg|jpg|gif|svg)'</span></div><div class="line">    ])</div><div class="line">        .pipe(rev())</div><div class="line">        .pipe(gulp.dest(<span class="string">'dist'</span>))</div><div class="line">        .pipe(rev.manifest())</div><div class="line">        .pipe(gulp.dest(<span class="string">'dist/manifest/img'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="4-第四步-处理样式文件"><a href="#4-第四步-处理样式文件" class="headerlink" title="4. 第四步 - 处理样式文件"></a>4. <em>第四步</em> - 处理样式文件</h4><p>相比于没有前端构建过程的原始方式，构建可以很方便的加入各种css预处理器，<code>Less</code>、<code>Sass</code>和<code>Stylus</code>都有对应的预处理gulp插件。这里选择了<code>gulp-less</code>插件作为less的处理器。并使用<code>gulp-minify-css</code>对处理后的css进行压缩。其中<code>gulp-rev-replace</code>插件用于将css中引用的图片文件路径替换为增md5后缀后的路径。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> less = <span class="built_in">require</span>(<span class="string">'gulp-less'</span>);</div><div class="line"><span class="keyword">var</span> minifycss = <span class="built_in">require</span>(<span class="string">'gulp-minify-css'</span>);</div><div class="line"><span class="keyword">var</span> replace = <span class="built_in">require</span>(<span class="string">'gulp-rev-replace'</span>);</div><div class="line"></div><div class="line">gulp.task(<span class="string">'less'</span>, [<span class="string">'image'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// 读取 图片  的路径映射表</span></div><div class="line">    <span class="keyword">var</span> manifest = gulp.src(<span class="string">'dist/manifest/img/rev-manifest.json'</span>);</div><div class="line">    <span class="keyword">return</span> gulp.src([</div><div class="line">        <span class="string">'public/**/pages/**/*.less'</span>,</div><div class="line">        <span class="string">'public/**/common/styles/style.less'</span></div><div class="line">    ])</div><div class="line">        .pipe(rev())</div><div class="line">        <span class="comment">// css预处理</span></div><div class="line">        .pipe(less())</div><div class="line">        <span class="comment">// 替换图片引用路径</span></div><div class="line">        .pipe(replace(&#123;<span class="attr">manifest</span>: manifest, <span class="attr">prefix</span>: prefix&#125;))</div><div class="line">        <span class="comment">// 压缩css代码</span></div><div class="line">        .pipe(minifycss())</div><div class="line">        <span class="comment">// 生成到目标路径</span></div><div class="line">        .pipe(gulp.dest(<span class="string">'dist'</span>))</div><div class="line">        <span class="comment">// 生成css文件路径映射</span></div><div class="line">        .pipe(rev.manifest())</div><div class="line">        .pipe(gulp.dest(<span class="string">'dist/manifest/css'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="5-第五步-处理脚本文件"><a href="#5-第五步-处理脚本文件" class="headerlink" title="5. 第五步 - 处理脚本文件"></a>5. <em>第五步</em> - 处理脚本文件</h4><p>gulp可以直接处理js脚本文件的压缩合并等工作，但在考虑js代码的模块化时，还要引入require.js或者seajs等模块加载器的对应插件。我们知道，webpack本身就是一个完备的前端构建工具，而且引入了一种新的模块化解决方案。这里我们将使用webpack的处理变成一个gulp任务，利用它的js模块化方案和打包压缩等功能，其他事情交给gulp来处理。</p>
<p>在gulp中使用webpack，我们需要使用<code>webpack-stream</code>插件。它直接将<code>main</code>作为唯一的入口entry，但是我们的工程不是单页面的，这样显然不行。例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">gulp.task(<span class="string">'webpack'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> gulp.src([ <span class="string">'public/pages/**/*.js'</span> ])</div><div class="line">        .pipe(webpackStream(&#123;</div><div class="line">            <span class="attr">output</span>: &#123;</div><div class="line">                <span class="attr">filename</span>: <span class="string">'[name].js'</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">resolve</span>: &#123;</div><div class="line">                <span class="attr">extensions</span>: [<span class="string">''</span>, <span class="string">'.js'</span>, <span class="string">'.jsx'</span>]</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">module</span>: &#123;</div><div class="line">                <span class="attr">loaders</span>: [&#123;</div><div class="line">                    <span class="attr">test</span>: <span class="regexp">/\.(js|jsx)$/</span>,</div><div class="line">                    <span class="attr">loader</span>: <span class="string">'babel-loader!jsx-loader?harmony'</span></div><div class="line">                &#125;]</div><div class="line">            &#125;</div><div class="line">        &#125;))</div><div class="line">        .pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>只生成了<code>dist</code>目录下的一个main.js文件。</p>
<p>为了将<code>gulp.src</code>中的文件直接作为webpack的entry，我们又引入了<code>vinyl-named</code>插件，它可以使用回调函数将文件路径中的匹配部分作为entry中的name配置。例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">gulp.task(<span class="string">'webpack'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> gulp.src([</div><div class="line">        <span class="string">'public/pages/**/*.js'</span></div><div class="line">    ])</div><div class="line">        .pipe(named(<span class="function"><span class="keyword">function</span> (<span class="params">file</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> dir = path.dirname(file.path);</div><div class="line">            <span class="comment">// 替换掉 public 目录路径</span></div><div class="line">            dir = dir.replace(<span class="regexp">/^.*public(\\|\/)/</span>, <span class="string">''</span>);</div><div class="line">            <span class="comment">// 将文件路径及 basename 作为 name</span></div><div class="line">            <span class="keyword">return</span> path.join(dir, path.basename(file.path, path.extname(file.path)));</div><div class="line">        &#125;))</div><div class="line">        .pipe(webpackStream(&#123;</div><div class="line">            <span class="attr">output</span>: &#123;</div><div class="line">                <span class="comment">// 指定输出文件名</span></div><div class="line">                filename: <span class="string">'[name].js'</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">resolve</span>: &#123;</div><div class="line">                <span class="attr">extensions</span>: [<span class="string">''</span>, <span class="string">'.js'</span>, <span class="string">'.jsx'</span>]</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">module</span>: &#123;</div><div class="line">                <span class="comment">// 设置加载器</span></div><div class="line">                loaders: [&#123;</div><div class="line">                    <span class="attr">test</span>: <span class="regexp">/\.(js|jsx)$/</span>,</div><div class="line">                    <span class="attr">loader</span>: <span class="string">'babel-loader!jsx-loader?harmony'</span></div><div class="line">                &#125;]</div><div class="line">            &#125;</div><div class="line">        &#125;))</div><div class="line">        .pipe(gulp.dest(<span class="string">'dist'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>生成了如下四个文件：</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pages<span class="symbol">\s</span>afe_grade<span class="symbol">\i</span>ndex<span class="symbol">\i</span>ndex.js</div><div class="line">pages<span class="symbol">\s</span>afe_grade<span class="symbol">\u</span>ser_info<span class="symbol">\u</span>ser_info.js</div><div class="line">pages<span class="symbol">\s</span>afe_grade<span class="symbol">\v</span>ideo_store<span class="symbol">\v</span>ideo_store.js</div></pre></td></tr></table></figure>
<p>webpack要实现代码的压缩等功能也需要使用到插件，这里使用到两个功能：</p>
<p>(1) 代码压缩</p>
<p>使用时在plugins配置的列表中增加一项：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> webpack.optimize.UglifyJsPlugin(&#123;</div><div class="line">    <span class="attr">compress</span>: &#123;</div><div class="line">        <span class="attr">warnings</span>: <span class="literal">false</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">mangle</span>: &#123;</div><div class="line">        <span class="attr">except</span>: [<span class="string">'$'</span>, <span class="string">'m'</span>, <span class="string">'window'</span>, <span class="string">'webpackJsonpCallback'</span>]</div><div class="line">    &#125;</div><div class="line">&#125;),</div></pre></td></tr></table></figure>
<p>其中mangle.except配置了在压缩过程中不被简化的变量，以防出现错误。<br>参考资料：<a href="http://webpack.github.io/docs/list-of-plugins.html#uglifyjsplugin" target="_blank" rel="external">http://webpack.github.io/docs/list-of-plugins.html#uglifyjsplugin</a></p>
<p>(2) 公共代码提取</p>
<p>使用时在plugins配置的列表中增加一项：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</div><div class="line">    <span class="attr">name</span>: <span class="string">'common/js/common'</span>,</div><div class="line">    <span class="attr">filename</span>: <span class="string">'common/js/common.js'</span>,</div><div class="line">    <span class="attr">minChunks</span>: <span class="number">2</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>参考资料：<a href="http://webpack.github.io/docs/list-of-plugins.html#commonschunkplugin" target="_blank" rel="external">http://webpack.github.io/docs/list-of-plugins.html#commonschunkplugin</a></p>
<p>代码构建及压缩后不容易阅读和调试，webpack也支持增加source map。只需设置devtool选项为’source-map’。当然，它还支持其他很多模式，具体可参考：<a href="http://www.07net01.com/2016/01/1120167.html" target="_blank" rel="external">webpack sourcemap 选项多种模式的一些解释</a></p>
<p>最终js构建代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> named = <span class="built_in">require</span>(<span class="string">'vinyl-named'</span>);</div><div class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</div><div class="line"><span class="keyword">var</span> webpackStream = <span class="built_in">require</span>(<span class="string">'webpack-stream'</span>);</div><div class="line"></div><div class="line">gulp.task(<span class="string">'webpack'</span>, [<span class="string">'image'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> revall = <span class="keyword">new</span> Revall(&#123;<span class="attr">hashLength</span>: <span class="number">10</span>&#125;);</div><div class="line">    <span class="keyword">var</span> manifest = gulp.src(<span class="string">'dist/manifest/img/rev-manifest.json'</span>);</div><div class="line">    <span class="keyword">return</span> gulp.src([</div><div class="line">        <span class="string">'public/pages/**/*.js'</span></div><div class="line">    ])</div><div class="line">        .pipe(named(<span class="function"><span class="keyword">function</span> (<span class="params">file</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> dir = path.dirname(file.path);</div><div class="line">            dir = dir.replace(<span class="regexp">/^.*public(\\|\/)/</span>, <span class="string">''</span>);</div><div class="line">            <span class="keyword">return</span> path.join(dir, path.basename(file.path, path.extname(file.path)));</div><div class="line">        &#125;))</div><div class="line">        .pipe(webpackStream(&#123;</div><div class="line">            <span class="attr">output</span>: &#123;</div><div class="line">                <span class="attr">filename</span>: <span class="string">'[name].js'</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">resolve</span>: &#123;</div><div class="line">                <span class="attr">extensions</span>: [<span class="string">''</span>, <span class="string">'.js'</span>, <span class="string">'.jsx'</span>]</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">module</span>: &#123;</div><div class="line">                <span class="attr">loaders</span>: [&#123;</div><div class="line">                    <span class="attr">test</span>: <span class="regexp">/\.(js|jsx)$/</span>,</div><div class="line">                    <span class="attr">loader</span>: <span class="string">'babel-loader!jsx-loader?harmony'</span></div><div class="line">                &#125;]</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">plugins</span>: [</div><div class="line">                <span class="comment">// 使用生产环境版本'react'</span></div><div class="line">                <span class="keyword">new</span> webpack.DefinePlugin(&#123;</div><div class="line">                    <span class="string">"process.env"</span>: &#123;</div><div class="line">                        <span class="attr">NODE_ENV</span>: <span class="built_in">JSON</span>.stringify(<span class="string">"production"</span>)</div><div class="line">                    &#125;</div><div class="line">                &#125;),</div><div class="line">                <span class="comment">//js文件的压缩</span></div><div class="line">                <span class="keyword">new</span> webpack.optimize.UglifyJsPlugin(&#123;</div><div class="line">                    <span class="attr">compress</span>: &#123;</div><div class="line">                        <span class="attr">warnings</span>: <span class="literal">false</span></div><div class="line">                    &#125;,</div><div class="line">                    <span class="attr">mangle</span>: &#123;</div><div class="line">                        <span class="attr">except</span>: [<span class="string">'$'</span>, <span class="string">'m'</span>, <span class="string">'window'</span>, <span class="string">'webpackJsonpCallback'</span>]</div><div class="line">                    &#125;</div><div class="line">                &#125;),</div><div class="line">                <span class="comment">//将公共代码抽离出来合并为一个文件</span></div><div class="line">                <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</div><div class="line">                    <span class="attr">name</span>: <span class="string">'common/js/common'</span>,</div><div class="line">                    <span class="attr">filename</span>: <span class="string">'common/js/common.js'</span>,</div><div class="line">                    <span class="attr">minChunks</span>: <span class="number">2</span></div><div class="line">                &#125;)</div><div class="line">            ],</div><div class="line">            <span class="attr">devtool</span>: <span class="string">'source-map'</span></div><div class="line">        &#125;))</div><div class="line">        .pipe(replace(&#123;<span class="attr">manifest</span>: manifest, <span class="attr">prefix</span>: prefix&#125;))</div><div class="line">        .pipe(revall.revision())</div><div class="line">        .pipe(gulp.dest(dest))</div><div class="line">        .pipe(revall.manifestFile())</div><div class="line">        .pipe(gulp.dest(<span class="string">'dist/manifest/webpack'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="6-第六步-增加文件监听"><a href="#6-第六步-增加文件监听" class="headerlink" title="6. 第六步 - 增加文件监听"></a>6. <em>第六步</em> - 增加文件监听</h4><p>gulp已经为我们提供了监听的工具，就是<code>watch</code>接口。使用方法也很简单，参看下面的例子。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">gulp.task(<span class="string">'watch'</span>, [<span class="string">'default'</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    gulp.watch([<span class="string">'public/**/*.+(ico|png|jpeg|jpg|gif|svg)'</span>], [<span class="string">'less'</span>, <span class="string">'webpack'</span>]);</div><div class="line">    gulp.watch([<span class="string">'public/**/*.less'</span>], [<span class="string">'less'</span>]);</div><div class="line">    gulp.watch([<span class="string">'public/**/*.js'</span>], [<span class="string">'js'</span>, <span class="string">'webpack'</span>]);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="补充："><a href="#补充：" class="headerlink" title="补充："></a><em>补充：</em></h4><p>暂无。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://corey600.github.io/2016/06/13/gulp-workflow/" data-id="cj1q6k9x3001fuoqdf8bj5bxf" class="article-share-link">分享到</a><div class="tags"><a href="/tags/前端/">前端</a><a href="/tags/gulp/">gulp</a><a href="/tags/webpack/">webpack</a></div><div class="post-nav"><a href="/2016/07/22/private-npm-service/" class="pre">私有NPM服务搭建</a><a href="/2016/01/04/flash-player/" class="next">Flash播放器研究</a></div><div class="comments-link-to"><span>想添加评论吗？给</span><span class="comments-email-to">我 (fcx600#163.com)</span><span>发邮件吧。或者请移步</span><a href="https://github.com/Corey600/static-blog/issues/new" target="_blank">这里</a><span>提交。</span></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/备忘/">备忘</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/总结/">总结</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载/">转载</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/04/20/react-international/">React多语言方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/15/node-performance-analysis/">由一个简单Node服务引申的Node性能分析方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/28/koa-and-co/">koa和co的简单分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/03/node-dubbo/">使用node开发dubbo远程调用客户端</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/22/private-npm-service/">私有NPM服务搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/13/gulp-workflow/">gulp前端构建工作流</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/04/flash-player/">Flash播放器研究</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/11/vagrant-instructions/">使用vagrant虚拟机开发调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/07/js-class-inheritance/">JS的类和继承的实现方法比较</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/16/fiddler-instructions/">Fiddler使用说明</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/ACM/" style="font-size: 15px;">ACM</a> <a href="/tags/VBox/" style="font-size: 15px;">VBox</a> <a href="/tags/TQ2440/" style="font-size: 15px;">TQ2440</a> <a href="/tags/串口/" style="font-size: 15px;">串口</a> <a href="/tags/LCD/" style="font-size: 15px;">LCD</a> <a href="/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/tags/SublimeText2/" style="font-size: 15px;">SublimeText2</a> <a href="/tags/G/" style="font-size: 15px;">G++</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/Octopress/" style="font-size: 15px;">Octopress</a> <a href="/tags/Vim/" style="font-size: 15px;">Vim</a> <a href="/tags/Win7/" style="font-size: 15px;">Win7</a> <a href="/tags/字符串/" style="font-size: 15px;">字符串</a> <a href="/tags/Jekyll/" style="font-size: 15px;">Jekyll</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/夏令时/" style="font-size: 15px;">夏令时</a> <a href="/tags/前端/" style="font-size: 15px;">前端</a> <a href="/tags/Fiddler/" style="font-size: 15px;">Fiddler</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/类/" style="font-size: 15px;">类</a> <a href="/tags/继承/" style="font-size: 15px;">继承</a> <a href="/tags/vagrant/" style="font-size: 15px;">vagrant</a> <a href="/tags/nfs/" style="font-size: 15px;">nfs</a> <a href="/tags/fis/" style="font-size: 15px;">fis</a> <a href="/tags/flash/" style="font-size: 15px;">flash</a> <a href="/tags/播放器/" style="font-size: 15px;">播放器</a> <a href="/tags/gulp/" style="font-size: 15px;">gulp</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a> <a href="/tags/npm/" style="font-size: 15px;">npm</a> <a href="/tags/cnpm/" style="font-size: 15px;">cnpm</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a> <a href="/tags/koa/" style="font-size: 15px;">koa</a> <a href="/tags/co/" style="font-size: 15px;">co</a> <a href="/tags/Node/" style="font-size: 15px;">Node</a> <a href="/tags/性能/" style="font-size: 15px;">性能</a> <a href="/tags/React/" style="font-size: 15px;">React</a> <a href="/tags/i18n/" style="font-size: 15px;">i18n</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Corey's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>